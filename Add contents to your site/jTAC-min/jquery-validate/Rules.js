if(!window.jTAC){throw new Error("window.jTAC not created.")}if(!window.jQuery||!$.validator){jTAC.error("Must load jquery and jquery-validate script files first.")}if($.validator.replaceTokens===undefined){jTAC.error("Must load /jTAC/jquery-validate/ReplaceTokens PlugIn.js script file before Rules.js.")}jTAC.require(["Connections.FormElement","TypeManagers.Base","Conditions.Base"]);jTAC.jqueryValidate=(function(){var unobtrusive=$.validator?$.validator.unobtrusive:null;function createCondition(element,condname,param){try{jTAC._internal.pushContext("jqueryValidate.createCondition()",condname);delete param.Condition;var cond;if(typeof(param)=="function"){cond=param()}else{if(typeof(param)=="object"){cond=jTAC.create(condname,param)}else{if((param===true)||(param==null)){cond=jTAC.create(condname,null)}else{jTAC.error("Value for a condition function must be an object.")}}}if(element&&(cond.connection instanceof jTAC.Connections.BaseElement)){cond.connection=jTAC.connectionResolver.create(element,cond.connection)}return cond}finally{jTAC._internal.popContext()}}function evaluate(element,condname,params){try{jTAC._internal.pushContext("jqueryValidate.evaluate()",condname);if(params==null){jTAC.error("Params must be assigned.")}if(!condname&&params.jtacClass){condname=params.jtacClass}delete params.jtacClass;var cond=params.Condition;if(!cond){cond=createCondition(element,condname,params);params.Condition=cond}if(!cond.canEvaluate.call(cond)){return"dependency-mismatch"}var r=cond.evaluate.call(cond);if(r==-1){return"dependency-mismatch"}return !!r}finally{jTAC._internal.popContext()}}function validate(validator,id){try{jTAC._internal.pushContext("jqueryValidate.validate('"+id+"')");var el=$("#"+id);if(el.valid()){validator.defaultShowErrors()}}finally{jTAC._internal.popContext()}}function defaultOptions(){var orig=$.prototype.validate;$.prototype.validate=function(options){if(this.length&&options){if(options.messagelabel===undefined){options.messagelabel="message-label"}if(options.labelErrorClass===undefined){options.labelErrorClass="label-validation-error"}if(options.containerErrorClass===undefined){options.containerErrorClass="container-validation-error"}if(options.messageErrorClass===undefined){options.messageErrorClass="message-validation-error"}if(options.messageValidClass===undefined){options.messageValidClass="message-validation-valid"}if(options.inputErrorClass===undefined){options.inputErrorClass=options.errorClass?options.errorClass:"input-validation-error"}options.errorClass=options.messageErrorClass;if(options.inputValidClass===undefined){options.inputValidClass=options.validClass?options.validClass:"input-validation-valid"}options.validClass=options.messageValidClass;if(unobtrusive||(options.errorPlacement===undefined)){if(!unobtrusive&&options.errorPlacement&&!options.errorPlacementFallback){options.errorPlacementFallback=options.errorPlacement}options.errorPlacement=$.proxy(onError,this[0])}if(unobtrusive||(options.success===undefined)){if(!unobtrusive&&options.success&&!options.successFallback){options.successFallback=options.success}options.success=$.proxy(onSuccess,this[0])}}return orig.call(this,options)}}defaultOptions();function mergeOptions(formElement,newOptions){var funcProps=["submitHandler","invalidHandler","invalidHandlerFallback","showErrors","errorPlacement","errorPlacementFallback","success","successFallback","highlight","unhighlight","highlight1","unhighlight1"];var validator=$.data(formElement[0],"validator");var options;if(validator&&validator.settings){options=validator.settings}else{validator=formElement.validate({});options=validator.settings}var val=newOptions.success||newOptions.successFallback;if(val){if(window[val]===undefined){funcProps.splice(funcProps.indexOf("success"),1)}}for(var propName in newOptions){if(!propName){continue}var val=newOptions[propName];if((funcProps.indexOf(propName)>-1)&&(typeof val=="string")){options[propName]=window[val];if((options[propName]==null)&&window.console){jTAC.warn("Validator options include the property ["+propName+" = '"+val+"']. This value must match a globally declared function.",null,"jqueryValidate.MergeOptions")}}else{options[propName]=val}}return options}function attachMultiConnections(formselector){try{jTAC._internal.pushContext("jqueryValidate.attachMultiConnections()");var form=$(formselector);if(!form||!form.length){return}var validator=$.data(form[0],"validator");var rules=validator.settings.rules;$.each(rules,function(key,value){if(!key){return}var el=document.getElementById(key);if(!el){el=document.getElementsByName(key);if(!el||!el.length){return}el=el[0]}$.each(value,function(childkey,paramcont){if(childkey=="messages"){return}var condname=ruleNameMap[childkey];if(condname==null){return}var srcId=el.id;var func=function(e){validate(validator,srcId)};try{var cond=createCondition(el,condname,paramcont.param?paramcont.param:paramcont);if(paramcont.param){paramcont.param.Condition=cond}var conns=[];cond.collectConnections(conns);for(var j=0;j<conns.length;j++){if(conns[j] instanceof jTAC.Connections.BaseElement){if(j>0){conns[j].addEventListener("onchange",func,"qvc"+el.id)}conns[j].addSupportEventListeners("onchange",func,"qvc"+el.id)}}}catch(e){jTAC.warn("Exception occurred when checking element "+srcId+", check the '"+condname+"' method. Exception message: "+e.message)}})})}finally{jTAC._internal.popContext()}}function installUnobtrusive(){if(runInstall){return}runInstall=true;try{jTAC._internal.pushContext("jqueryValidate.installUnobtrusive()");var forms=$("form");$.each(forms,function(key,form){form=$(form);var newOptions=form.data("val-options");if(newOptions){try{if(typeof newOptions=="string"){newOptions=window.eval("("+newOptions+");")}mergeOptions(form,newOptions)}catch(e){jTAC.error("Could not parse the data-val-options attribute of form id ["+form.get()[0].id+"] Error info:"+e.toString())}}attachMultiConnections(form)})}finally{jTAC._internal.popContext()}}var runInstall=false;if(unobtrusive){var postInit=[];unobtrusive.nativeParse=unobtrusive.parse;unobtrusive.parse=function(selector){unobtrusive.nativeParse(selector);installUnobtrusive();for(var i=0;i<postInit.length;i++){postInit[i]()}}}function registerConditionsAsRules(){try{jTAC._internal.pushContext("jqueryValidate.registerConditionsAsRules()");var defs=jTAC._internal.definitions;for(var fullClassName in defs){var def=jTAC.getDefinition(fullClassName);if(def.inst instanceof jTAC.Conditions.Base){if(!def.inst.$abstract){useConditionAsRule(def.inst.ruleName(),fullClassName)}}}}finally{jTAC._internal.popContext()}}var defaultMessages={};var ruleNameMap=[];function useConditionAsRule(ruleName,fullClassName){ruleNameMap[ruleName]=fullClassName;var ruleFnc=function(value,element,params){return evaluate.call(this,element,fullClassName,params)};var emFnc=function(ruleparms,element){return retrieveErrorMessage(ruleName,ruleparms)};$.validator.addMethod(ruleName,ruleFnc,emFnc);if($.validator.replaceTokens){$.validator.replaceTokens[ruleName]=replaceTokens}if($.validator.unobtrusive){$.validator.unobtrusive.adapters.add(ruleName,["json"],function(options){try{var obj=options.params.json?eval("("+options.params.json+")"):{};options.rules[ruleName]={param:obj}}catch(e){jTAC.error("Syntax error in data-val-"+ruleName+"-json attribute of the HTML element "+options.element.id+". Error reported: "+e+" Attribute value: "+options.params.json.toString())}if(options.message){options.messages[ruleName]=options.message}})}}function retrieveErrorMessage(ruleName,param){var cond=param.Condition;var defmsg=defaultMessages[ruleName];if(!defmsg){defmsg=defaultMessages[ruleName]=jTAC.translations.lookup(ruleName+"EM",cond.defaultErrorMessage())}if(cond&&cond.getLookupKey){var key=cond.getLookupKey();if(key){defmsg=jTAC.translations.lookup(key,defmsg)}}return defmsg}function replaceTokens(message,element,param,value){try{var cond=param.Condition;if(cond&&cond.replaceTokens){var validator=$.data(element.form,"validator");message=cond.replaceTokens.call(cond,message,{element:element,value:value,validator:validator,context:"html",messagelabel:validator.settings.messagelabel})}}catch(e){jTAC.warn('Exception occurred replacing tokens in message "'+message+'" of element '+(element?element.id:"[unknown]")+" Exception: "+e.message,null,"jqueryValidate.replaceTokens()")}return message}registerConditionsAsRules();function onError(error,inputElement){var validator=$.data(this,"validator");var options=validator.settings;var name=inputElement[0].name||inputElement[0].id;var container=$(this).find("[data-valmsg-for='"+name+"']");if(!container||!container.length){error.removeClass(options.messageValidClass).addClass(options.messageErrorClass);if(options.errorPlacementFallback){options.errorPlacementFallback.call(validator,error,inputElement)}else{error.insertAfter(inputElement)}return}container.removeClass("field-validation-valid").addClass("field-validation-error");error.data("unobtrusiveContainer",container);var ec=$(container).data("jtac-errorclass");if(ec==null){ec=options.messageErrorClass}var vc=$(container).data("jtac-validclass");if(vc==null){vc=options.messageValidClass}error.removeClass(vc).addClass(ec);var replace=$.parseJSON(container.attr("data-valmsg-replace"))!==false;if(replace){container.empty();error.appendTo(container)}else{error.hide()}}function onSuccess(error){var validator=$.data(this,"validator");var options=validator.settings;var container=error.data("unobtrusiveContainer");if(!container||!container.length){error.removeClass(options.messageErrorClass).addClass(options.messageValidClass);var fb=options.successFallback;if(fb!=null){if(typeof fb=="string"){label.addClass(fb)}else{fb.call(validator,error)}}return}if(container){var ec=$(container).data("jtac-errorclass");if(ec==null){ec=options.messageErrorClass}var vc=$(container).data("jtac-validclass");if(vc==null){vc=options.messageValidClass}container.removeClass("field-validation-error").addClass("field-validation-valid");error.removeData("unobtrusiveContainer");error.removeClass(ec).addClass(vc);var replace=$.parseJSON(container.attr("data-valmsg-replace"));if(replace){container.empty()}}}function defaultShowErrors(){function captureH(el,ec,vc){if(!el||!el.id){return}if(elementsFound[el.id]==undefined){elementsFound[el.id]={valid:false,element:el}}}function captureU(el,ec,vc){if(!el||!el.id){return}if((elementsFound[el.id]==undefined)||elementsFound[el.id]){elementsFound[el.id]={valid:true,element:el}}}try{jTAC._internal.pushContext("jqueryValidate.defaultShowErrors()");var elementsFound={};var options=this.settings;var svH=options.highlight;var svUH=options.unhighlight;try{options.highlight=captureH;options.unhighlight=captureU;origDefaultShowErrors.call(this)}finally{options.highlight=svH;options.unhighlight=svUH}if(svH||svUH||options.labelErrorClass||options.containerErrorClass){gatherElements(this,elementsFound);if(svH||svUH){hilightInputs(this,elementsFound)}hilightNearby(this,elementsFound)}}finally{jTAC._internal.popContext()}}var origDefaultShowErrors=$.validator.prototype.defaultShowErrors;$.validator.prototype.defaultShowErrors=defaultShowErrors;function gatherElements(validator,elementsFound){var rules=validator.settings.rules;$.each(rules,function(key,value){if(!key){return}$.each(value,function(childkey,paramcont){if(childkey=="messages"){return}var holder=paramcont.param||paramcont.params||paramcont;var cond=holder.Condition;if(!cond){return}var last=cond.getLastEvaluateResult();if((last==-1)||(last==null)){return}try{var conns=[];cond.collectConnections(conns);for(var j=0;j<conns.length;j++){var conn=conns[j];if(conn instanceof jTAC.Connections.BaseElement){var el=conn.getElement();if(!el||!el.id){continue}if((elementsFound[el.id]===undefined)||elementsFound[el.id].valid){elementsFound[el.id]={valid:last==1,element:el}}}}}catch(e){jTAC.warn("Exception occurred when checking elements for the "+key+"' rule. Exception: "+e.message,null,"jqueryValidate.gatherElements()")}})})}function hilightInputs(validator,elementsFound){var options=validator.settings;for(var propName in elementsFound){var r=elementsFound[propName];var fnc=r.valid?options.unhighlight:options.highlight;if(fnc){var ec=$(r.element).data("jtac-errorclass");if(ec==null){ec=options.inputErrorClass}var vc=$(r.element).data("jtac-validclass");if(vc==null){vc=options.inputValidClass}fnc.call(validator,r.element,ec,vc)}}}function hilightNearby(validator,elementsFound){var options=validator.settings;if(options.labelErrorClass===undefined){options.labelErrorClass="label-validation-error"}if(options.containerErrorClass===undefined){options.containerErrorClass="container-validation-error"}if(!options.labelErrorClass&&!options.containerErrorClass){return}if(!options.cssNearby){options.cssNearby=defaultCssNearby}var labels=$("Label");$.each(labels,function(key,value){var id=value.htmlFor;if(id&&elementsFound[id]&&!value.getAttribute("generated")){options.cssNearby.call(this,value,options.labelErrorClass,elementsFound[id].valid)}});var containers=$("[data-jtac-valinputs]");$.each(containers,function(key,value){var ids=$(value).data("jtac-valinputs");if(ids==null){return}if(ids==""){for(var propName in elementsFound){var r=elementsFound[propName];var p=r.element.parentNode;while(p&&(p.tagName!="FORM")){if(p==value){options.cssNearby.call(this,value,options.containerErrorClass,r.valid);break}p=p.parentNode}}}else{ids=ids.split("|");for(var i=0;i<ids.length;i++){var id=ids[i];if(id&&elementsFound[id]){options.cssNearby.call(this,value,options.containerErrorClass,elementsFound[id].valid)}}}})}function defaultCssNearby(elToUpdate,css,isValid){var elToUpdate=$(elToUpdate);var local=elToUpdate.data("jtac-errorclass");if(local){css=local}if(css==null){return}if(isValid){elToUpdate.removeClass(css)}else{elToUpdate.addClass(css)}}var publics={createCondition:createCondition,evaluate:evaluate,validate:validate,attachMultiConnections:attachMultiConnections,installUnobtrusive:installUnobtrusive,mergeOptions:mergeOptions,postInit:postInit};publics._internal={useConditionAsRule:useConditionAsRule};return publics}());